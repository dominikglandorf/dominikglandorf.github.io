<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Normal Distributions Visualization</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jstat@latest/dist/jstat.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        .controls {
            margin: 20px 0;
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .chart-container {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .legend {
            display: flex;
            gap: 20px;
            margin-top: 10px;
            justify-content: center;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .legend-color {
            width: 20px;
            height: 3px;
        }
        .sample-dot {
            opacity: 0.6;
        }
        button {
            padding: 8px 16px;
            background-color: #2E86C1;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #2874A6;
        }
        input[type="number"] {
            width: 80px;
            padding: 4px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .stats-panel {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .t-stat {
            font-weight: bold;
            color: #2874A6;
        }
        .histogram-container {
            margin-top: 20px;
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .histogram-bar {
            fill: #34495E;
            opacity: 0.8;
        }
        .histogram-bar:hover {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="controls">
        <div class="control-group">
            <label for="altMean">Alternative Hypothesis Mean:</label>
            <input type="range" id="altMean" min="0" max="4" step="0.1" value="2">
            <span id="altMeanValue">2.0</span>
        </div>
        <div class="control-group">
            <label for="sampleSize">Sample Size:</label>
            <input type="number" id="sampleSize" min="1" max="1000" value="50">
            <button id="drawSamples">Draw Samples</button>
        </div>
    </div>
    
    <div class="chart-container" id="visualization"></div>
    
    <div class="legend">
        <div class="legend-item">
            <div class="legend-color" style="background-color: #2E86C1;"></div>
            <span>Null Hypothesis</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: #E74C3C;"></div>
            <span>Alternative Hypothesis</span>
        </div>
    </div>

    <div class="stats-panel" id="tStatPanel"></div>
    <div class="histogram-container" id="tStatHistogram"></div>

    <script>
        // Set up the visualization parameters
        const margin = {top: 20, right: 20, bottom: 30, left: 40};
        const width = 600 - margin.left - margin.right;
        const height = 300 - margin.top - margin.bottom;

        // Create the SVG container
        const svg = d3.select("#visualization")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        // Set up scales
        const x = d3.scaleLinear()
            .domain([-4, 8])
            .range([0, width]);

        const y = d3.scaleLinear()
            .domain([0, 0.5])
            .range([height, 0]);

        // Add X axis
        svg.append("g")
            .attr("transform", `translate(0,${height})`)
            .call(d3.axisBottom(x));

        // Add Y axis
        svg.append("g")
            .call(d3.axisLeft(y));

        // Normal distribution function
        function normalPDF(x, mean = 0, sd = 1) {
            return (1 / (sd * Math.sqrt(2 * Math.PI))) * 
                   Math.exp(-0.5 * Math.pow((x - mean) / sd, 2));
        }

        // Generate points for the curves
        function generateCurvePoints(mean = 0, sd = 1) {
            return d3.range(-4, 8.1, 0.1).map(x => ({
                x: x,
                y: normalPDF(x, mean, sd)
            }));
        }

        // Box-Muller transform to generate normal random samples
        function generateNormalSample(mean = 0, sd = 1) {
            const u1 = Math.random();
            const u2 = Math.random();
            const z = Math.sqrt(-2.0 * Math.log(u1)) * Math.cos(2.0 * Math.PI * u2);
            return z * sd + mean;
        }

        // Create line generator
        const line = d3.line()
            .x(d => x(d.x))
            .y(d => y(d.y));

        let altMean = 2;

        // Calculate mean and standard deviation
        function calculateStats(samples) {
            const mean = samples.reduce((a, b) => a + b, 0) / samples.length;
            const variance = samples.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / samples.length;
            const std = Math.sqrt(variance);
            return { mean, std };
        }

        // Calculate t-statistic
        function calculateTStatistic(samples1, samples2) {
            const n1 = samples1.length;
            const n2 = samples2.length;
            const stats1 = calculateStats(samples1);
            const stats2 = calculateStats(samples2);
            
            // Pooled standard deviation
            const sp = Math.sqrt(
                ((n1 - 1) * Math.pow(stats1.std, 2) + (n2 - 1) * Math.pow(stats2.std, 2)) / 
                (n1 + n2 - 2)
            );
            
            // Standard error
            const se = sp * Math.sqrt(1/n1 + 1/n2);
            
            // t-statistic
            const t = (stats2.mean - stats1.mean) / se;
            
            // Degrees of freedom
            const df = n1 + n2 - 2;
            
            return {
                t,
                df,
                sp,
                se,
                stats1,
                stats2
            };
        }

        // Format number with proper spacing
        function formatNumber(num, decimals = 2) {
            return num.toFixed(decimals).padStart(8);
        }

        // Array to store t-statistics
        let tStatHistory = [];

        // Create histogram SVG
        const histMargin = {top: 20, right: 20, bottom: 30, left: 40};
        const histWidth = 600 - histMargin.left - histMargin.right;
        const histHeight = 200 - histMargin.top - histMargin.bottom;

        const histSvg = d3.select("#tStatHistogram")
            .append("svg")
            .attr("width", histWidth + histMargin.left + histMargin.right)
            .attr("height", histHeight + histMargin.top + histMargin.bottom)
            .append("g")
            .attr("transform", `translate(${histMargin.left},${histMargin.top})`);

        // Add histogram title
        histSvg.append("text")
            .attr("x", histWidth / 2)
            .attr("y", -5)
            .attr("text-anchor", "middle")
            .style("font-size", "14px")
            .text("Distribution of t-statistics");

        // Add x-axis with fixed range
        const histX = d3.scaleLinear()
            .domain([-20, 20])
            .range([0, histWidth]);

        const histXAxis = histSvg.append("g")
            .attr("class", "x-axis")
            .attr("transform", `translate(0,${histHeight})`)
            .call(d3.axisBottom(histX));

        // Add y-axis
        const histY = d3.scaleLinear()
            .range([histHeight, 0]);

        const histYAxis = histSvg.append("g")
            .attr("class", "y-axis");

        // Critical t-value line
        const criticalLine = histSvg.append("line")
            .attr("class", "critical-t-line")
            .attr("stroke", "#E74C3C")
            .attr("stroke-width", 2)
            .attr("stroke-dasharray", "4,4");

        // Critical t-value label
        const criticalLabel = histSvg.append("text")
            .attr("class", "critical-t-label")
            .attr("text-anchor", "start")
            .attr("fill", "#E74C3C")
            .attr("font-size", "12px");

        // Function to get critical t-value
        function getCriticalT(df, alpha = 0.05) {
            return Math.abs(jStat.studentt.inv(alpha, df));
        }

        // Function to update histogram
        function updateHistogram() {
            if (tStatHistory.length === 0) return;

            // Generate histogram bins with fixed domain
            const bins = d3.histogram()
                .domain([-20, 20])
                .thresholds(40)(tStatHistory);

            // Update y domain based on bins
            histY.domain([0, d3.max(bins, d => d.length)]);

            // Update y-axis
            histYAxis.call(d3.axisLeft(histY));

            // Update bars
            const bars = histSvg.selectAll(".histogram-bar")
                .data(bins);

            bars.exit().remove();

            bars.enter()
                .append("rect")
                .attr("class", "histogram-bar")
                .merge(bars)
                .transition()
                .duration(300)
                .attr("x", d => histX(d.x0))
                .attr("width", d => Math.max(0, histX(d.x1) - histX(d.x0) - 1))
                .attr("y", d => histY(d.length))
                .attr("height", d => histHeight - histY(d.length));

            // Update count labels
            const texts = histSvg.selectAll(".bar-text")
                .data(bins);

            texts.exit().remove();

            texts.enter()
                .append("text")
                .attr("class", "bar-text")
                .merge(texts)
                .transition()
                .duration(300)
                .attr("x", d => histX(d.x0) + (histX(d.x1) - histX(d.x0)) / 2)
                .attr("y", d => histY(d.length) - 5)
                .attr("text-anchor", "middle")
                .attr("font-size", "10px")
                .text(d => d.length > 0 ? d.length : "");

            // Update critical t-value line
            const sampleSize = parseInt(document.getElementById("sampleSize").value);
            const df = 2 * sampleSize - 2;
            const criticalT = getCriticalT(df);

            criticalLine
                .attr("x1", histX(criticalT))
                .attr("x2", histX(criticalT))
                .attr("y1", 0)
                .attr("y2", histHeight)
                .style("opacity", 1);

            criticalLabel
                .attr("x", histX(criticalT) + 5)
                .attr("y", 15)
                .text(`Critical t = ${criticalT.toFixed(3)}`)
                .style("opacity", 1);
        }

        // Draw the curves and samples
        function updateCurves(drawNewSamples = false) {
            // Clear previous curves, samples, and stats
            svg.selectAll(".distribution-curve").remove();
            if (drawNewSamples) {
                svg.selectAll(".sample-dot").remove();
                svg.selectAll(".sample-stats").remove();
            }

            const nullPoints = generateCurvePoints(0, 1);
            const altPoints = generateCurvePoints(altMean, 1);

            // Draw null hypothesis curve
            svg.append("path")
                .datum(nullPoints)
                .attr("class", "distribution-curve")
                .attr("fill", "none")
                .attr("stroke", "#2E86C1")  // Blue
                .attr("stroke-width", 2)
                .attr("d", line);

            // Draw alternative hypothesis curve
            svg.append("path")
                .datum(altPoints)
                .attr("class", "distribution-curve")
                .attr("fill", "none")
                .attr("stroke", "#E74C3C")  // Red
                .attr("stroke-width", 2)
                .attr("d", line);

            if (drawNewSamples) {
                const sampleSize = parseInt(document.getElementById("sampleSize").value);
                
                // Generate samples and calculate statistics
                const nullSamples = Array.from({length: sampleSize}, () => generateNormalSample(0, 1));
                const altSamples = Array.from({length: sampleSize}, () => generateNormalSample(altMean, 1));
                
                // Calculate t-statistic
                const tStats = calculateTStatistic(nullSamples, altSamples);
                
                // Add t-statistic to history
                tStatHistory.push(tStats.t);
                
                // Update histogram
                updateHistogram();
                
                // Update t-statistic panel
                const tStatPanel = document.getElementById("tStatPanel");
                tStatPanel.innerHTML = `Two-Sample t-Test Calculation:
                
H₀ Sample (n₁=${nullSamples.length}):  μ̂₁ = ${formatNumber(tStats.stats1.mean)}, σ̂₁ = ${formatNumber(tStats.stats1.std)}
H₁ Sample (n₂=${altSamples.length}):  μ̂₂ = ${formatNumber(tStats.stats2.mean)}, σ̂₂ = ${formatNumber(tStats.stats2.std)}

Pooled SD (sp) = √[((n₁-1)σ̂₁² + (n₂-1)σ̂₂²)/(n₁+n₂-2)] = ${formatNumber(tStats.sp)}
Std Error (SE) = sp·√(1/n₁ + 1/n₂) = ${formatNumber(tStats.se)}

t = (μ̂₂ - μ̂₁)/SE = ${formatNumber(tStats.t)}
df = n₁ + n₂ - 2 = ${tStats.df}`;

                // Draw null hypothesis samples and stats
                svg.selectAll(".null-sample")
                    .data(nullSamples)
                    .enter()
                    .append("circle")
                    .attr("class", "sample-dot")
                    .attr("cx", d => x(d))
                    .attr("cy", height)
                    .attr("r", 4)
                    .attr("fill", "#2E86C1");

                // Draw alternative hypothesis samples and stats
                svg.selectAll(".alt-sample")
                    .data(altSamples)
                    .enter()
                    .append("circle")
                    .attr("class", "sample-dot")
                    .attr("cx", d => x(d))
                    .attr("cy", height)
                    .attr("r", 4)
                    .attr("fill", "#E74C3C");

                // Add sample statistics visualization
                const statsGroup = svg.append("g")
                    .attr("class", "sample-stats");

                // Null hypothesis stats
                statsGroup.append("rect")
                    .attr("x", x(tStats.stats1.mean - tStats.stats1.std))
                    .attr("y", 0)
                    .attr("width", x(tStats.stats1.mean + tStats.stats1.std) - x(tStats.stats1.mean - tStats.stats1.std))
                    .attr("height", height)
                    .attr("fill", "#2E86C1")
                    .attr("opacity", 0.1);

                statsGroup.append("line")
                    .attr("x1", x(tStats.stats1.mean))
                    .attr("x2", x(tStats.stats1.mean))
                    .attr("y1", 0)
                    .attr("y2", height)
                    .attr("stroke", "#2E86C1")
                    .attr("stroke-width", 2)
                    .attr("stroke-dasharray", "4,4");

                // Alternative hypothesis stats
                statsGroup.append("rect")
                    .attr("x", x(tStats.stats2.mean - tStats.stats2.std))
                    .attr("y", 0)
                    .attr("width", x(tStats.stats2.mean + tStats.stats2.std) - x(tStats.stats2.mean - tStats.stats2.std))
                    .attr("height", height)
                    .attr("fill", "#E74C3C")
                    .attr("opacity", 0.1);

                statsGroup.append("line")
                    .attr("x1", x(tStats.stats2.mean))
                    .attr("x2", x(tStats.stats2.mean))
                    .attr("y1", 0)
                    .attr("y2", height)
                    .attr("stroke", "#E74C3C")
                    .attr("stroke-width", 2)
                    .attr("stroke-dasharray", "4,4");

                // Add text labels for means and standard deviations
                statsGroup.append("text")
                    .attr("x", x(tStats.stats1.mean))
                    .attr("y", 15)
                    .attr("text-anchor", "middle")
                    .attr("fill", "#2E86C1")
                    .text(`μ̂₀=${tStats.stats1.mean.toFixed(2)}, σ̂₀=${tStats.stats1.std.toFixed(2)}`);

                statsGroup.append("text")
                    .attr("x", x(tStats.stats2.mean))
                    .attr("y", 35)
                    .attr("text-anchor", "middle")
                    .attr("fill", "#E74C3C")
                    .text(`μ̂₁=${tStats.stats2.mean.toFixed(2)}, σ̂₁=${tStats.stats2.std.toFixed(2)}`);
            }
        }

        // Handle alternative mean slider
        const altMeanSlider = document.getElementById("altMean");
        const altMeanValue = document.getElementById("altMeanValue");

        altMeanSlider.addEventListener("input", function() {
            altMean = parseFloat(this.value);
            altMeanValue.textContent = altMean.toFixed(1);
            updateCurves(false);
        });

        // Handle draw samples button
        document.getElementById("drawSamples").addEventListener("click", function() {
            updateCurves(true);
        });

        // Initial draw
        updateCurves(false);

        // Add clear button to reset histogram
        const clearButton = document.createElement("button");
        clearButton.textContent = "Clear History";
        clearButton.style.marginLeft = "10px";
        document.querySelector(".control-group:last-child").appendChild(clearButton);

        // Add draw multiple samples button
        const drawMultipleButton = document.createElement("button");
        drawMultipleButton.textContent = "Draw 100 Samples";
        drawMultipleButton.style.marginLeft = "10px";
        document.querySelector(".control-group:last-child").appendChild(drawMultipleButton);

        clearButton.addEventListener("click", function() {
            tStatHistory = [];
            histSvg.selectAll(".histogram-bar").remove();
            histSvg.selectAll(".bar-text").remove();
            criticalLine.style("opacity", 0);
            criticalLabel.style("opacity", 0);
        });

        // Add event listener for drawing multiple samples
        drawMultipleButton.addEventListener("click", async function() {
            const button = this;
            button.disabled = true;
            button.textContent = "Drawing...";
            
            // Use setTimeout to allow UI to update before starting the loop
            setTimeout(async () => {
                for (let i = 0; i < 100; i++) {
                    updateCurves(true);
                    // Small delay to prevent browser from freezing
                    await new Promise(resolve => setTimeout(resolve, 10));
                }
                button.disabled = false;
                button.textContent = "Draw 100 Samples";
            }, 0);
        });
    </script>
</body>
</html> 