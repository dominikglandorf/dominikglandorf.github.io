<html>
    <head>
        <title>InterestLearn</title>
        <link rel="stylesheet" type="text/css" href="style.css">
        <script   src="https://code.jquery.com/jquery-3.6.4.min.js"   integrity="sha256-oP6HI9z1XaZNBrJURtCoUT5SUnxFr8s3BzRl+cbzUq8="   crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js" integrity="sha512-3j3VU6WC5rPQB4Ld1jnLV7Kd5xr+cq9avvhwqzbH/taCRNURoeEpoPBK9pDyeukwSxwRPJ8fDgvYXd6SkaZ2TA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
        <script>
            const MODEL = "gpt-3.5-turbo"
            var messages = []
            var language
            var niveau

            async function complete(userMessage) {
                messages.push({"role": "user", "content": userMessage})
                postData = {
                    "model": MODEL,
                    "messages": messages
                }
                

                result = await $.ajax({
                    type: "POST",
                    url: "https://api.openai.com/v1/chat/completions",
                    headers: { "Authorization": "Bearer " + $("#api-key").val() },
                    contentType: "application/json",
                    data: JSON.stringify(postData)
                });

                assistantMessage = result.choices[0].message
                messages.push(assistantMessage);
                console.log(assistantMessage);
                return assistantMessage.content
            }

            async function getText() {
                language = $("#language").val();
                niveau = $("#niveau").val();
                topic = $("#topic").val();
                prompt = `Write a text of 100 words about "${topic}" in ${niveau} ${language}.`
                
                $('#loading').css('display', 'inline-block');
                $('#generate').prop('disabled', true);
                response = await complete(prompt);
                $('#loading').css('display', 'none');
                $('#generate').prop('disabled', false);
                $('#output').text(response);
            }

            async function getMeaning() {
                selection = $("#selection").text();
                prompt = `Explain "${selection}" in its context. The explanation should be in ${language} and have one or two sentences.`;

                $('#loading-exp').css('display', 'inline-block');
                $('#explain').prop('disabled', true);
                response = await complete(prompt);
                $('#loading-exp').css('display', 'none');
                $('#explain').prop('disabled', false);
                $('#explanation').text(`"${selection}": ${response}`).show()
                $("#lookup").hide();
            }

            $(function() {
                apiKey = $.cookie("api-key"); // get potentially existing apiKey from cookie
                $('#api-key').val(apiKey ? apiKey : ""); // set apiKey field
                $('#api-key').change(function() { // when apiKey is changed by user
                    $.cookie("api-key", $(this).val(), { expires: 365, path: '/' }); // save to cookie
                });

                $("#output, #explanation").on("mouseup touchend", function() {
                    const selectedText = window.getSelection().toString();
                    if (selectedText.length > 0) {
                        $("#selection").text(selectedText);
                        $("#lookup").show(); 
                    } else {
                        $("#lookup").hide();
                    }
                });
            });
        </script>
    </head>
    <body>
        <div id="app">
            <div id="panel">
                <p>API Key: <input type="text" id="api-key" value="" size="34"/></p>
                <p>Language:
                    <select id="language">
                        <option>English</option>
                        <option selected="selected">French</option>
                        <option>Spanish</option>
                    </select>
                
                Proficiency: <select id="niveau">
                        <option>Beginner</option>
                        <option>Intermediate</option>
                        <option selected="selected">Advanced</option>
                    </select>
                </p>
                <p>Topic: <input type="text" id="topic" value="" size="27" />
                    <input type="button" value="Generate" id="generate" onClick="getText();" />
                </p>
                <div id="loading" style="display: none" class="lds-ring"><div></div><div></div><div></div><div></div></div>
            </div>
            
            
            <div id="output">
                
            </div>
            <br />
            <div id="lookup" style="display: none" >
            Do you want to get "<span id="selection"></span>" explained?
            <input type="button" value="Explain" id="explain" onClick="getMeaning();" /><br />
            <div id="loading-exp" style="display: none" class="lds-ring"><div></div><div></div><div></div><div></div></div>
            </div>

            <div id="explanation" style="display: none">

            </div>


        </div>
    </body>
</html>